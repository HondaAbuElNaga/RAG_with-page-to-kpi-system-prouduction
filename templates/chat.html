<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø¹Ù‡Ø¯</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f4f9; display: flex; flex-direction: column; height: 100vh; }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 80%; padding: 12px 18px; border-radius: 15px; line-height: 1.6; position: relative; }
        .user-message { align-self: flex-start; background-color: #007bff; color: white; border-bottom-right-radius: 2px; }
        .bot-message { align-self: flex-end; background-color: #e9ecef; color: #333; border-bottom-left-radius: 2px; }
        .input-area { background: white; padding: 20px; border-top: 1px solid #ddd; display: flex; gap: 10px; }
        .loading { font-style: italic; color: #888; font-size: 0.9em; display: none;}
    </style>
</head>
<body>

    <div class="chat-container" id="chatBox">
        <div class="message bot-message">
            Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! ğŸ‘‹ Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ Ø§Ù„Ù…ØªØ®ØµØµ. ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ØŸ
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." onkeypress="handleEnter(event)">
        <button onclick="sendMessage()" class="btn btn-primary px-4">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>

    <script>
        const chatBox = document.getElementById('chatBox');
        const userInput = document.getElementById('userInput');
        let chatHistory = []; // Ù„ØªØ®Ø²ÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø­Ù„ÙŠØ§Ù‹ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù…Ø¹ ÙƒÙ„ Ø·Ù„Ø¨

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text) return;

            // 1. Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            appendMessage(text, 'user-message');
            userInput.value = '';
            
            // 2. Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙƒØ§Ù† Ù„Ø±Ø¯ Ø§Ù„Ø¨ÙˆØª
            const botMsgDiv = document.createElement('div');
            botMsgDiv.className = 'message bot-message';
            botMsgDiv.innerText = '...'; // Ù…Ø¤Ø´Ø± Ø§Ù„ÙƒØªØ§Ø¨Ø©
            chatBox.appendChild(botMsgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // 3. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ±
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, history: chatHistory })
                });

                // 4. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø¯ (Streaming)
                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");
                botMsgDiv.innerText = ""; // Ù…Ø³Ø­ Ø§Ù„Ù…Ø¤Ø´Ø±
                let fullBotResponse = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    fullBotResponse += chunk;
                    botMsgDiv.innerText += chunk; // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Øµ ØªØ¯Ø±ÙŠØ¬ÙŠØ§Ù‹
                    chatBox.scrollTop = chatBox.scrollHeight; // Ø§Ù„Ù†Ø²ÙˆÙ„ Ù„Ù„Ø£Ø³ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                }

                // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®
                chatHistory.push([text, fullBotResponse]);

            } catch (error) {
                botMsgDiv.innerText = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.";
                botMsgDiv.style.color = "red";
            }
        }

        function appendMessage(text, className) {
            const div = document.createElement('div');
            div.className = `message ${className}`;
            div.innerText = text;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>